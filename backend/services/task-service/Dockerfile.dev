# Development stage
FROM node:20-alpine
WORKDIR /app

# Install build dependencies
RUN apk add --no-cache python3 make g++

# Copy package files
COPY backend/services/shared-kernel/package*.json ./backend/services/shared-kernel/
COPY backend/services/task-service/package*.json ./backend/services/task-service/

# Install dependencies
WORKDIR /app/backend/services/shared-kernel
RUN npm install

WORKDIR /app/backend/services/task-service
RUN npm install

# Copy source code
COPY backend/services/shared-kernel/tsconfig.json /app/backend/services/shared-kernel/
COPY backend/services/shared-kernel/src /app/backend/services/shared-kernel/src

COPY backend/services/task-service/tsconfig.json ./
COPY backend/services/task-service/src ./src

# Set environment variables
ENV NODE_ENV=development
ENV PORT=3455

# Expose the port the app runs on
EXPOSE 3455

# Start the app in development mode
CMD ["npm", "run", "start:dev"]
